

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>Fluentd? ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ íŒ¨í‚¤ì§•! - </title>

  <meta name="description" content="Overview
ì„¸ìƒì—ëŠ” ìˆ˜ë§ì€ ëª¨ë‹ˆí„°ë§ ë„êµ¬ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ìµœê·¼ ë§ì´ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤ì¸ Prometheusì™€ ìˆ˜ë§ì€ exporterê°€ ê·¸ì¤‘ í•˜ë‚˜ì…ì£ . ë§¤íŠ¸ë¦­ ìˆ˜ì§‘ì— ìµœì í™”ëœ ì´ëŸ° êµ¬ì„±ì€ ì‹œìŠ¤í…œì˜ ìƒíƒœ ê°’ì„ ìˆ˜ì§‘í•˜ê¸°ì—ëŠ” ë”ì—†ì´ ì¢‹ì€ ì‹œìŠ¤í…œì´ê¸°ëŠ” í•©ë‹ˆë‹¤ë§Œ, ë¡œê·¸ì„± ë°ì´í„° ìˆ˜ì§‘(ì—ëŸ¬ë¡œê·¸ í˜¹ì€ syslog)ì—ëŠ” ì•„ë¬´ë˜ë„ í•œê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
ì´ ê²½ìš°, td-agentì™€ ê°™ì€ ë²”ìš©ì ì¸ ë¡œê·¸ ìˆ˜ì§‘ ì—ì´ì „íŠ¸ë¥¼ í™œìš©í•˜ê²Œ ë˜ëŠ”ë°ìš”. (í˜¹ì€ ìì²´ì ìœ¼ë¡œ êµ¬í˜„ì„ í•˜ê±°ë‚˜) íƒ€íŒ€ê³¼ í˜¼ì¬í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë¬¸ì œ ë°œìƒì†Œì§€ê°€ ìˆê¸´í•©ë‹ˆë‹¤. ì°¸ê³ ë¡œ, td-agentëŠ” ruby ë¿ë§Œ ì•„ë‹ˆë¼, í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì„ íŒ¨í‚¤ì§€ ë‚´ë¶€ì— í¬í•¨ì‹œì¼œì„œ, OS ì˜ì¡´ì„±ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.">
  <meta name="author" content="gywndi"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "gywn\u0027s tech",
    
    "url": "\/\/localhost:1313\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "\/\/localhost:1313\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "\/\/localhost:1313\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "\/\/localhost:1313\/2021\/09\/package-own-fluentd-agent\/",
          "name": "Fluentd? ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ íŒ¨í‚¤ì§•!"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "gywndi"
  },
  "headline": "Fluentd? ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ íŒ¨í‚¤ì§•!",
  "description" : "Overview ì„¸ìƒì—ëŠ” ìˆ˜ë§ì€ ëª¨ë‹ˆí„°ë§ ë„êµ¬ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ìµœê·¼ ë§ì´ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤ì¸ Prometheusì™€ ìˆ˜ë§ì€ exporterê°€ ê·¸ì¤‘ í•˜ë‚˜ì…ì£ . ë§¤íŠ¸ë¦­ ìˆ˜ì§‘ì— ìµœì í™”ëœ ì´ëŸ° êµ¬ì„±ì€ ì‹œìŠ¤í…œì˜ ìƒíƒœ ê°’ì„ ìˆ˜ì§‘í•˜ê¸°ì—ëŠ” ë”ì—†ì´ ì¢‹ì€ ì‹œìŠ¤í…œì´ê¸°ëŠ” í•©ë‹ˆë‹¤ë§Œ, ë¡œê·¸ì„± ë°ì´í„° ìˆ˜ì§‘(ì—ëŸ¬ë¡œê·¸ í˜¹ì€ syslog)ì—ëŠ” ì•„ë¬´ë˜ë„ í•œê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.\nì´ ê²½ìš°, td-agentì™€ ê°™ì€ ë²”ìš©ì ì¸ ë¡œê·¸ ìˆ˜ì§‘ ì—ì´ì „íŠ¸ë¥¼ í™œìš©í•˜ê²Œ ë˜ëŠ”ë°ìš”. (í˜¹ì€ ìì²´ì ìœ¼ë¡œ êµ¬í˜„ì„ í•˜ê±°ë‚˜) íƒ€íŒ€ê³¼ í˜¼ì¬í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë¬¸ì œ ë°œìƒì†Œì§€ê°€ ìˆê¸´í•©ë‹ˆë‹¤. ì°¸ê³ ë¡œ, td-agentëŠ” ruby ë¿ë§Œ ì•„ë‹ˆë¼, í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì„ íŒ¨í‚¤ì§€ ë‚´ë¶€ì— í¬í•¨ì‹œì¼œì„œ, OS ì˜ì¡´ì„±ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.\n",
  "inLanguage" : "en",
  "wordCount":  2058 ,
  "datePublished" : "2021-09-07T03:26:39\u002b00:00",
  "dateModified" : "2021-09-07T03:26:39\u002b00:00",
  "image" : "\/\/localhost:1313\/img\/avatar-sdc-angry.png",
  "keywords" : [ "fluentd, my-agent, MySQL" ],
  "mainEntityOfPage" : "\/\/localhost:1313\/2021\/09\/package-own-fluentd-agent\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "\/\/localhost:1313\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "\/\/localhost:1313\/img\/avatar-sdc-angry.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Fluentd? ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ íŒ¨í‚¤ì§•!" />
<meta property="og:description" content="Overview
ì„¸ìƒì—ëŠ” ìˆ˜ë§ì€ ëª¨ë‹ˆí„°ë§ ë„êµ¬ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ìµœê·¼ ë§ì´ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤ì¸ Prometheusì™€ ìˆ˜ë§ì€ exporterê°€ ê·¸ì¤‘ í•˜ë‚˜ì…ì£ . ë§¤íŠ¸ë¦­ ìˆ˜ì§‘ì— ìµœì í™”ëœ ì´ëŸ° êµ¬ì„±ì€ ì‹œìŠ¤í…œì˜ ìƒíƒœ ê°’ì„ ìˆ˜ì§‘í•˜ê¸°ì—ëŠ” ë”ì—†ì´ ì¢‹ì€ ì‹œìŠ¤í…œì´ê¸°ëŠ” í•©ë‹ˆë‹¤ë§Œ, ë¡œê·¸ì„± ë°ì´í„° ìˆ˜ì§‘(ì—ëŸ¬ë¡œê·¸ í˜¹ì€ syslog)ì—ëŠ” ì•„ë¬´ë˜ë„ í•œê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
ì´ ê²½ìš°, td-agentì™€ ê°™ì€ ë²”ìš©ì ì¸ ë¡œê·¸ ìˆ˜ì§‘ ì—ì´ì „íŠ¸ë¥¼ í™œìš©í•˜ê²Œ ë˜ëŠ”ë°ìš”. (í˜¹ì€ ìì²´ì ìœ¼ë¡œ êµ¬í˜„ì„ í•˜ê±°ë‚˜) íƒ€íŒ€ê³¼ í˜¼ì¬í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë¬¸ì œ ë°œìƒì†Œì§€ê°€ ìˆê¸´í•©ë‹ˆë‹¤. ì°¸ê³ ë¡œ, td-agentëŠ” ruby ë¿ë§Œ ì•„ë‹ˆë¼, í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì„ íŒ¨í‚¤ì§€ ë‚´ë¶€ì— í¬í•¨ì‹œì¼œì„œ, OS ì˜ì¡´ì„±ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.">
<meta property="og:image" content="//localhost:1313/img/avatar-sdc-angry.png" />
<meta property="og:url" content="//localhost:1313/2021/09/package-own-fluentd-agent/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="gywn&#39;s tech" />

  <meta name="twitter:title" content="Fluentd? ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ íŒ¨í‚¤ì§•!" />
  <meta name="twitter:description" content="Overview
ì„¸ìƒì—ëŠ” ìˆ˜ë§ì€ ëª¨ë‹ˆí„°ë§ ë„êµ¬ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ìµœê·¼ ë§ì´ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤ì¸ Prometheusì™€ ìˆ˜ë§ì€ exporterê°€ ê·¸ì¤‘ í•˜ë‚˜ì…ì£ . ë§¤íŠ¸ë¦­ ìˆ˜ì§‘ì— ìµœì í™”ëœ ì´ëŸ° êµ¬ì„±ì€ ì‹œìŠ¤í…œì˜ ìƒíƒœ ê°’ì„ ìˆ˜ì§‘í•˜ê¸°ì—ëŠ” ë”ì—†ì´ ì¢‹ì€ ì‹œìŠ¤í…œì´ê¸°ëŠ” í•©ë‹ˆë‹¤ë§Œ, ë¡œê·¸ì„± ë°ì´í„° ìˆ˜ì§‘(ì—ëŸ¬ë¡œê·¸ í˜¹ì€ syslog)ì—ëŠ” ì•„ë¬´ë˜ë„ í•œê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
ì´ ê²½ â€¦">
  <meta name="twitter:image" content="//localhost:1313/img/avatar-sdc-angry.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='//localhost:1313/img/favicon-sdc.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.147.8">
  <link rel="alternate" href="//localhost:1313/index.xml" type="application/rss+xml" title="gywn&#39;s tech"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css" integrity="sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="//localhost:1313/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="//localhost:1313/css/highlight.min.css" /><link rel="stylesheet" href="//localhost:1313/css/codeblock.css" />
  
  <link rel="stylesheet" href="//localhost:1313/css/custom.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="//localhost:1313/">gywn&#39;s tech</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="gywn&#39;s tech" href="//localhost:1313/">
            <img class="avatar-img" src="//localhost:1313/img/avatar-sdc-angry.png" alt="gywn&#39;s tech" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Fluentd? ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ íŒ¨í‚¤ì§•!</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on 2021-09-07
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;10&nbsp;minutes
  
  
  
    
      
        &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;gywndi
      
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h1 id="overview">Overview</h1>
<p>ì„¸ìƒì—ëŠ” ìˆ˜ë§ì€ ëª¨ë‹ˆí„°ë§ ë„êµ¬ë“¤ì´ ìˆìŠµë‹ˆë‹¤. ìµœê·¼ ë§ì´ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤ì¸ Prometheusì™€ ìˆ˜ë§ì€ exporterê°€ ê·¸ì¤‘ í•˜ë‚˜ì…ì£ . ë§¤íŠ¸ë¦­ ìˆ˜ì§‘ì— ìµœì í™”ëœ ì´ëŸ° êµ¬ì„±ì€ ì‹œìŠ¤í…œì˜ ìƒíƒœ ê°’ì„ ìˆ˜ì§‘í•˜ê¸°ì—ëŠ” ë”ì—†ì´ ì¢‹ì€ ì‹œìŠ¤í…œì´ê¸°ëŠ” í•©ë‹ˆë‹¤ë§Œ, ë¡œê·¸ì„± ë°ì´í„° ìˆ˜ì§‘(ì—ëŸ¬ë¡œê·¸ í˜¹ì€ syslog)ì—ëŠ” ì•„ë¬´ë˜ë„ í•œê³„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.</p>
<p>ì´ ê²½ìš°, td-agentì™€ ê°™ì€ ë²”ìš©ì ì¸ ë¡œê·¸ ìˆ˜ì§‘ ì—ì´ì „íŠ¸ë¥¼ í™œìš©í•˜ê²Œ ë˜ëŠ”ë°ìš”. (í˜¹ì€ ìì²´ì ìœ¼ë¡œ êµ¬í˜„ì„ í•˜ê±°ë‚˜) íƒ€íŒ€ê³¼ í˜¼ì¬í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë¬¸ì œ ë°œìƒì†Œì§€ê°€ ìˆê¸´í•©ë‹ˆë‹¤. ì°¸ê³ ë¡œ, td-agentëŠ” ruby ë¿ë§Œ ì•„ë‹ˆë¼, í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì„ íŒ¨í‚¤ì§€ ë‚´ë¶€ì— í¬í•¨ì‹œì¼œì„œ, OS ì˜ì¡´ì„±ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.</p>
<p>ì˜¤ëŠ˜ í¬ìŠ¤íŒ…ì—ì„œëŠ” <strong>td-agentì™€ ê°™ì´ fluentdë¥¼ íŒ¨í‚¤ì§•í•˜ëŠ” ë°©ë²•</strong>ì— ëŒ€í•´ì„œ ì´ì•¼ê¸°ë¥¼ í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
<h1 id="packaging-environment">Packaging environment</h1>
<p>ì´ì œë¶€í„° ì´ì•¼ê¸°í•  ë‚´ìš©ì€ ê¸°ë³¸ì ìœ¼ë¡œ CentOS7 ê¸°ë°˜ì„ ì „ì œë¡œ í•©ë‹ˆë‹¤. ì°¸ê³ ë¡œ, CentOS6 ê²½ìš°ì—ëŠ” EOL ì—¬íŒŒì¸ì§€ ëª¨ë¥´ì§€ë§Œ.. YUM ë ˆíŒŒì§€í† ë¦¬ ê´€ë¦¬ ë¿ë§Œ ì•„ë‹ˆë¼.. ì†Œì†Œí•œ ëª‡ëª‡ ë¬¸ì œê°€ ìˆì–´ì„œ. ì¡°ê¸ˆ ê·€ì°®ì•„ì§€ë”ë¼ê³ ìš”. ğŸ™‚</p>
<p>íŒ¨í‚¤ì§• í™˜ê²½ì„ êµ¬ì„±í•˜ê¸° ìœ„í•œ ë°©ì•ˆì€ Dockerë¥¼ ì´ìš©í•´ë³´ëŠ” ë°©ë²•ê³¼ Vagrantë¥¼ í™œìš©í•˜ì—¬ ë¹ ë¥´ê²Œ OSì´ë¯¸ì§€ë¥¼ ë°›ì•„ì˜¤ëŠ” ë°©ë²•ì´ì£ .</p>
<h2 id="1-docker">1. Docker</h2>
<p>Dockerê°€ ì •ìƒì ìœ¼ë¡œ êµ¬ì„±ì´ ë˜ì–´ ìˆëŠ” í™˜ê²½ì—ì„œ, ì•„ë˜ì™€ ê°™ì´ ê°„ë‹¨í•˜ê²Œ CentOS7 í™˜ê²½ì„ ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤. ë§Œì•½ centos:7 ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´, ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ë°›ì•„ì™€ì„œ ì»¨í…Œì´ë„ˆë¥¼ ì˜ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker run -d -it --name<span class="o">=</span>pkg-dev centos:7 bash
</span></span><span class="line"><span class="cl">$ docker <span class="nb">exec</span> -it pkg-dev bash
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@f02a337793f9 /<span class="o">]</span><span class="c1"># yum -y install net-tools sysstat telnet bash wget openssl md5 tar bzip2 patch gcc git autoconf openssl-devel</span>
</span></span></code></pre></div><h2 id="2-vagrant">2. Vagrant</h2>
<p>VirtualBoxë¥¼ ì“¸ ìˆ˜ ìˆëŠ” í™˜ê²½ì´ë¼ë©´, Vargrantë„ ì¢‹ì€ ëŒ€ì•ˆì´ê¸°ë„ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ë§¥ë¶ í™˜ê²½ ê¸°ì¤€ìœ¼ë¡œ vagrant êµ¬ì„±í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## Install vagrant with brew</span>
</span></span><span class="line"><span class="cl">$ brew install cask
</span></span><span class="line"><span class="cl">$ brew install --cask virtualbox
</span></span><span class="line"><span class="cl">$ brew install --cask vagrant
</span></span><span class="line"><span class="cl">$ brew install --cask vagrant-manager
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;export PATH=$PATH:/opt/vagrant/bin:.&#39;</span> &gt;&gt; ~/.zshrc
</span></span><span class="line"><span class="cl">$ . ~/.zshrc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ mkdir -p ~/Document/vagrant/centos7-node01
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> ~/Document/vagrant/centos7-node01
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## Vagrant file</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">Vagrant.configure(&#39;2&#39;) do |config|
</span></span></span><span class="line"><span class="cl"><span class="s2">  config.vm.box = &#39;centos/7&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">  # config.vm.network &#34;</span>private_network<span class="s2">&#34;, ip: &#34;</span>192.168.56.60<span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">  config.vm.provider &#39;virtualbox&#39; do |vb|
</span></span></span><span class="line"><span class="cl"><span class="s2">    vb.gui = true
</span></span></span><span class="line"><span class="cl"><span class="s2">    vb.memory = &#39;2048&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">    vb.customize [&#39;modifyvm&#39;, :id, &#39;--audio&#39;, &#39;none&#39;]
</span></span></span><span class="line"><span class="cl"><span class="s2">  end
</span></span></span><span class="line"><span class="cl"><span class="s2">  config.vm.provision &#39;shell&#39;, inline: &lt;-SHELL
</span></span></span><span class="line"><span class="cl"><span class="s2">    yum update -y
</span></span></span><span class="line"><span class="cl"><span class="s2">    yum -y install net-tools sysstat telnet bash wget openssl md5 tar bzip2 patch gcc git autoconf openssl-devel
</span></span></span><span class="line"><span class="cl"><span class="s2">    echo &#39;test12&#39; | passwd --stdin root
</span></span></span><span class="line"><span class="cl"><span class="s2">    sed -i &#39;s/PasswordAuthentication no/PasswordAuthentication yes/g&#39; /etc/ssh/sshd_config
</span></span></span><span class="line"><span class="cl"><span class="s2">    /sbin/service sshd restart
</span></span></span><span class="line"><span class="cl"><span class="s2">  SHELL
</span></span></span><span class="line"><span class="cl"><span class="s2">end&#34;</span> &gt; Vagrantfile
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vagrant up
</span></span></code></pre></div><p>ì°¸ê³ ë¡œ, ìœ„ Vagrant íŒŒì¼ì€ 2G ë©”ëª¨ë¦¬(<code>vb.memory = '2048'</code>)ì™€ ì‚¬ìš©ì „ í•„ìš”í• ë§Œí•œ ê²ƒë“¤ì€ ì´ê²ƒì €ê²ƒ(?) ì„¤ì¹˜ë¥¼ í•˜ê³ , root íŒ¨ìŠ¤ì›Œë“œë¥¼ <code>'test12'</code>ë¡œ êµ¬ì„±í•˜ëŠ” ì„¤ì •ì…ë‹ˆë‹¤. ë§Œì•½ ë‚´ë¶€ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬ì„±í•˜ê³  ì‹¶ë‹¤ë©´, ìœ„ ì„¤ì •ì—ì„œ ì£¼ì„ì„ í’€ê³  ì•„ì´í”¼ë¥¼ ì ë‹¹í•˜ê²Œ ë³€ê²½í•˜ì‹œê³  <code>vagrant up</code> ì„ ìˆ˜í–‰í•˜ë©´ ë©ë‹ˆë‹¤.</p>
<p>ì´ê²ƒ ì™¸ì—ë„ ì‚¬ì‹¤.. KVMì„ í™œìš©í•œ ë¦¬ëˆ…ìŠ¤ ìì²´ì—ì„œ Virtual machineì„ ìƒì„±í•˜ëŠ” ë°©ë²•ë„ ìˆì§€ë§Œ, ì´ê±´ ìŠ¤í‚µ! ğŸ™‚</p>
<p>ì´ì œ ë‚˜ë§Œì˜ íŒ¨í‚¤ì§•ì„ ìœ„í•œ OS ì„¸íŒ…ì€ ì™„ë£Œë˜ì—ˆìœ¼ë‹ˆ, ì´ì œë¶€í„° ì œëŒ€ë¡œ ì‹œì‘ì„ í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
<h1 id="ruby-packaging">Ruby packaging</h1>
<p>FluentdëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ruby ìœ„ì—ì„œ êµ¬ë™ë˜ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ìµœì¢…ì ì¸ ëª©í‘œëŠ” ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´, íŒ¨í‚¤ì§•í•œ ë£¨ë¹„ ìœ„ì—, fluentdë¥¼ êµ¬ì„±í•˜ê³ , ê¸°íƒ€ í•„ìš”í•œ fluentd ì „ìš© í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
<img src="/img/2021/09/image-1.png" alt=""></p>
<p>ì²«ë²ˆì§¸ ë‹¨ê³„ë¡œ ìš°ì„  Rubyë¥¼ íŠ¹ì • ë””ë ‰í† ë¦¬ ì•ˆì— íŒ¨í‚¤ì§•ì„ í•´ë³´ì£ . ì´ê²ƒì„ ìœ„í•´ ruby-install ì´ë¼ëŠ” ìœ í‹¸ë¦¬í‹°ë¥¼ ì‚¬ìš©í† ë¡ í•˜ê² ìŠµë‹ˆë‹¤.<br>
<a href="https://github.com/postmodern/ruby-install">https://github.com/postmodern/ruby-install</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">########################</span>
</span></span><span class="line"><span class="cl"><span class="c1">## Disable ssl</span>
</span></span><span class="line"><span class="cl"><span class="c1">########################</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;sslverify=false&#34;</span> &gt;&gt; /etc/yum.conf
</span></span><span class="line"><span class="cl">$ yum -y install make
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">########################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ruby-install</span>
</span></span><span class="line"><span class="cl"><span class="c1">########################</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">V_RUBY_INSTALL</span><span class="o">=</span><span class="s2">&#34;0.8.2&#34;</span>
</span></span><span class="line"><span class="cl">$ wget -O ruby-install-<span class="si">${</span><span class="nv">V_RUBY_INSTALL</span><span class="si">}</span>.tar.gz https://github.com/postmodern/ruby-install/archive/v<span class="si">${</span><span class="nv">V_RUBY_INSTALL</span><span class="si">}</span>.tar.gz
</span></span><span class="line"><span class="cl">$ tar -xzvf ruby-install-<span class="si">${</span><span class="nv">V_RUBY_INSTALL</span><span class="si">}</span>.tar.gz
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> ruby-install-<span class="si">${</span><span class="nv">V_RUBY_INSTALL</span><span class="si">}</span>/
</span></span><span class="line"><span class="cl">$ make install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">########################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># embeded-ruby</span>
</span></span><span class="line"><span class="cl"><span class="c1">########################</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">V_RUBY</span><span class="o">=</span><span class="s2">&#34;2.7.4&#34;</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/opt/my-agent/lib
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/opt/my-agent/bin
</span></span><span class="line"><span class="cl">$ ruby-install --install-dir /opt/my-agent ruby <span class="si">${</span><span class="nv">V_RUBY</span><span class="si">}</span> -- --enable-shared <span class="nv">CPPFLAGS</span><span class="o">=</span>-I/opt/my-agent/include <span class="nv">LDFLAGS</span><span class="o">=</span>-L/opt/my-agent/lib
</span></span></code></pre></div><p>ì´ ê³¼ì •ì„ ê±°ì¹˜ê³ ë‚˜ë©´, <code>/opt/my-agent</code> í•˜ë‹¨ì— í•˜ë‹¨ ê°™ì€ ëª¨ìŠµìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ls -al /opt/my-agent
</span></span><span class="line"><span class="cl">total <span class="m">24</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">6</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 ..
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 bin
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 include
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 lib
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">5</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 share
</span></span></code></pre></div><p>ì´ì œ fluentd íŒ¨í‚¤ì§•ì„ ìœ„í•œ Ruby í™˜ê²½ êµ¬ì„±ì€ ë§ˆë¬´ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
<h1 id="install-fluentd">Install fluentd</h1>
<p>Rubyê°€ íŒ¨í‚¤ì§•ì´ ì˜ ì´ë£¨ì–´ì¡Œìœ¼ë‹ˆ. ì´ì œ fluentdë¥¼ ë£¨ë¹„ í™˜ê²½ì— ì˜ ë„£ì–´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## fluentd</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /opt/my-agent
</span></span><span class="line"><span class="cl">$ ./bin/gem install fluentd
</span></span><span class="line"><span class="cl">$ ./bin/fluentd -s conf
</span></span><span class="line"><span class="cl">Installed conf/fluent.conf.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ls -al
</span></span><span class="line"><span class="cl">total <span class="m">28</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">7</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 09:04 .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 ..
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 09:03 bin
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 09:04 conf
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 include
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 lib
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">5</span> root root <span class="m">4096</span> Sep  <span class="m">2</span> 08:06 share
</span></span></code></pre></div><p>ì´ì œ ê°ê° í•„ìš”í• ë§Œí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì„ ì»´íŒŒì¼í•˜ë©´ì„œ <code>/opt/my-agent/lib</code>ì— ë„£ì–´ë³´ë„ë¡ í•´ë³´ì£ . <code>jemalloc</code>, <code>libyaml</code>, <code>openssl</code>ì´ ì—†ì„ìˆ˜ë„ ìˆì„ë§Œí•œ í™˜ê²½ì„ ìœ„í•´ì„œ, ì•„ë˜ì™€ ê°™ì´ ê°ê° ì»´íŒŒì¼ì„ í•´ì„œ ì§„í–‰í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³ , mysqlì„ ì§ì ‘ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ë„ ìˆê¸°ì—, <code>mysql client</code> ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ë„ í•˜ë‹¨ê³¼ ê°™ì´ ì˜ í¬í•¨ì‹œì¼œ ì¤ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## jemalloc</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">$ git clone https://github.com/jemalloc/jemalloc.git
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> jemalloc
</span></span><span class="line"><span class="cl">$ ./autogen.sh --prefix<span class="o">=</span>/opt/my-agent
</span></span><span class="line"><span class="cl">$ make <span class="o">&amp;&amp;</span> make install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## libyaml</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">V_LIB_YAML</span><span class="o">=</span><span class="s2">&#34;0.2.5&#34;</span>
</span></span><span class="line"><span class="cl">$ wget --no-check-certificate http://pyyaml.org/download/libyaml/yaml-<span class="si">${</span><span class="nv">V_LIB_YAML</span><span class="si">}</span>.tar.gz
</span></span><span class="line"><span class="cl">$ tar xzvf yaml-<span class="si">${</span><span class="nv">V_LIB_YAML</span><span class="si">}</span>.tar.gz
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> yaml-<span class="si">${</span><span class="nv">V_LIB_YAML</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">$ ./configure --prefix /opt/my-agent
</span></span><span class="line"><span class="cl">$ make <span class="o">&amp;&amp;</span> make install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## openssl</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">V_OPENSSL</span><span class="o">=</span><span class="s2">&#34;1.1.1&#34;</span>
</span></span><span class="line"><span class="cl">$ wget https://www.openssl.org/source/old/<span class="si">${</span><span class="nv">V_OPENSSL</span><span class="si">}</span>/openssl-<span class="si">${</span><span class="nv">V_OPENSSL</span><span class="si">}</span>.tar.gz
</span></span><span class="line"><span class="cl">$ tar xzvf openssl-<span class="si">${</span><span class="nv">V_OPENSSL</span><span class="si">}</span>.tar.gz
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> openssl-<span class="si">${</span><span class="nv">V_OPENSSL</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">$ ./config --prefix<span class="o">=</span>/opt/my-agent
</span></span><span class="line"><span class="cl">$ make <span class="o">&amp;&amp;</span> make install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## mysql client</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">$ yum -y install mysql-devel mysql-libs
</span></span><span class="line"><span class="cl">$ cp -R /usr/lib64/mysql/libmysqlclient* /opt/my-agent/lib/
</span></span><span class="line"><span class="cl">$ mkdir -p /opt/my-agent/include
</span></span><span class="line"><span class="cl">$ cp -R /usr/include/mysql /opt/my-agent/include/
</span></span></code></pre></div><p>ì! ì´ì œ ê¸°ë³¸ì ì¸ fluentd íŒ¨í‚¤ì§•ì€ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤. ì´ì œë¶€í„°ëŠ” í•„ìš”í•œ í”ŒëŸ¬ê·¸ì¸ë“¤ì„ ì„¤ì¹˜í•  ë‹¨ê³„ì…ë‹ˆë‹¤.</p>
<h1 id="install-fluentd-plugins">Install fluentd plugins</h1>
<p>ì œ ì…ì¥ì—ì„œëŠ” ì‚¬ìš©í•´ë³¼ë§Œí•œ í”Œë¡œê·¸ì¸ì€ í¬ê²Œ ì•„ë˜ ì„¸ê°€ì§€ë¡œ ê¼½ì•„ë³¼ ìˆ˜ ìˆì„ ë“¯ í•˜ë„¤ìš”.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">cd</span> /opt/my-agent/bin
</span></span><span class="line"><span class="cl">$ ./gem install fluent-plugin-out-http
</span></span><span class="line"><span class="cl">$ ./gem install fluent-plugin-mysqlslowquery
</span></span><span class="line"><span class="cl">$ ./gem install fluent-plugin-mysql-query
</span></span></code></pre></div><p>ê° í”ŒëŸ¬ê·¸ì¸ì— ê°„ë‹¨í•˜ê²Œ ì„¤ëª…ì„ í•´ë³´ì£ .</p>
<h3 id="31-fluent-plugin-out-http">3.1. fluent-plugin-out-http</h3>
<p>sourceë¡œë¶€í„° ì „ë‹¬ë°›ì€ ë‚´ìš©ì„ íŠ¹ì • HTTP APIë¡œ ì „ë‹¬í•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ, ì €ëŠ” ê°œì¸ì ìœ¼ë¡œ ì—ëŸ¬ë¡œê·¸ ìˆ˜ì§‘ì— í™œìš©ì„ í•´ë³´ê³  ìˆìŠµë‹ˆë‹¤. ì—ëŸ¬ë¡œê·¸ ìˆ˜ì§‘ì„ ìœ„í•œ ìƒ˜í”Œì…ë‹ˆë‹¤. ì°¸ê³ ë¡œ, <code>http://192.168.56.101:5000/errorlog</code> ìˆ˜ì§‘ API ëŠ” ë³„ë„ë¡œ êµ¬í˜„ì„ í•´ì•¼í•˜ëŠ” ê²ƒì€ ì•„ì‹œì£ ? (ê¸°íšŒê°€ ëœë‹¤ë©´, ì´ê²ƒë„ í•œë²ˆ. ì½”ë“œë¡œ ê³µìœ ë¥¼. ã…ã…)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;source&gt;</span>
</span></span><span class="line"><span class="cl">  @type tail
</span></span><span class="line"><span class="cl">  path /data/mysql/*.err
</span></span><span class="line"><span class="cl">  pos_file /opt/my-agent/log/mysql.error.pos
</span></span><span class="line"><span class="cl">  tag mysql.error
</span></span><span class="line"><span class="cl">  format none
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;filter</span> <span class="err">mysql.error</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  @type record_transformer
</span></span><span class="line"><span class="cl">  enable_ruby
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;record&gt;</span>
</span></span><span class="line"><span class="cl">    hostname ${hostname}
</span></span><span class="line"><span class="cl">    timestamp ${time.to_i}
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/record&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/filter&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;match</span> <span class="err">mysql.error</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  @type http
</span></span><span class="line"><span class="cl">  buffer_type file
</span></span><span class="line"><span class="cl">  buffer_path /opt/my-agent/log/mysql.error.*.buffer
</span></span><span class="line"><span class="cl">  flush_interval 1s
</span></span><span class="line"><span class="cl">  endpoint_url   http://192.168.56.101:5000/errorlog
</span></span><span class="line"><span class="cl">  http_method    post
</span></span><span class="line"><span class="cl">  #serializer     json
</span></span><span class="line"><span class="cl">  #bulk_request   true
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/match&gt;</span>
</span></span></code></pre></div><p><code>v1.2.2</code>ì—ì„œëŠ” ë¼ì¸ë‹¨ìœ„ë¡œ ëª…ì‹œëœ endpoint_urlì„ ë§¤ë²ˆ í˜¸ì¶œí•˜ëŠ” í˜•íƒœë¡œ êµ¬í˜„ì´ ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl"># bulk_request: false
</span></span><span class="line"><span class="cl">error line1 ========&gt; API call
</span></span><span class="line"><span class="cl">error line2 ========&gt; API call
</span></span><span class="line"><span class="cl">error line3 ========&gt; API call
</span></span><span class="line"><span class="cl">error line4 ========&gt; API call
</span></span><span class="line"><span class="cl">error line5 ========&gt; API call
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># bulk_request: true
</span></span><span class="line"><span class="cl">error line1
</span></span><span class="line"><span class="cl">error line2
</span></span><span class="line"><span class="cl">error line3
</span></span><span class="line"><span class="cl">error line4
</span></span><span class="line"><span class="cl">error line5 ========&gt; API call (line1~line5)
</span></span></code></pre></div><p>ì¼ë°˜ì ì¸ ìƒí™©ì—ì„œëŠ” í° ë¬¸ì œê°€ ë˜ì§€ ì•Šì§€ë§Œ, ëª‡ì²œ ë¼ì¸ì˜ ì—ëŸ¬ë¡œê·¸ê°€ ìˆœì‹ê°„ì— ìƒì„±ì´ ë˜ì—ˆì„ ë•Œ.. ìˆ˜ì§‘ íš¨ìœ¨ì´ êµ‰ì¥íˆ ë–¨ì–´ì§ˆ ìˆ˜ ë°–ì— ì—†ê² ì£ . í˜„ ë²„ì „ì—ì„œëŠ” <code>bulk_request</code>ì˜µì…˜ì´ ì¶”ê°€ë˜ë©´ì„œ, ëŒ€ëµ 1MB ë¯¸ë§Œ(600K~800K)ìœ¼ë¡œ ë°ì´í„°ë¥¼ ëŠì–´ì„œ</p>
<p><code>application/x-ndjson</code>ë¡œ ë¬¶ì–´ì„œ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. (í•œë²ˆì— ì „ë‹¬ë°›ì€ ë©”ì‹œì§€ë¥¼ ë¬¶ì–´ì„œ ë””ë¹„ insert ì²˜ë¦¬ë¥¼ í•˜ë‹ˆ, ë§Œê±´ ë¡œê·¸ë„ í° ë¬´ë¦¬ì—†ì´ í•œë²ˆì— ì˜ ë„£ê¸´ í•˜ë„¤ìš”. ã…)</p>
<p>ì˜µì…˜ì— ëŒ€í•œ ì¶”ê°€ ë‚´ìš©ì€ í•˜ë‹¨ ê¹ƒì„ ì½ì–´ë³´ì‹œê³ , í•„ìš”í•œ ê²ƒë“¤ì„ ì˜ ì‚¬ìš©í•´ë³´ë©´ ì¢‹ê² ë„¤ìš”. ^^<br>
<a href="https://github.com/fluent-plugins-nursery/fluent-plugin-out-http">https://github.com/fluent-plugins-nursery/fluent-plugin-out-http</a></p>
<h3 id="32-fluent-plugin-mysqlslowquery">3.2. fluent-plugin-mysqlslowquery</h3>
<p>MySQL ìŠ¬ë¡œìš° ì¿¼ë¦¬ ìˆ˜ì§‘ì„ ìœ„í•œ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ.. ìŠ¬ë¡œìš° ë¡œê·¸ ìœ„ì¹˜ë¥¼ ì§€ì •í•´ë†“ìœ¼ë©´, ì˜ íŒŒì‹±í•´ì„œ ì „ë‹¬í•´ì¤ë‹ˆë‹¤. ì•„ë˜ëŠ” ìƒ˜í”Œ ì„¤ì •ì…ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;source&gt;</span>
</span></span><span class="line"><span class="cl">  @type mysql_slow_query
</span></span><span class="line"><span class="cl">  path /var/lib/mysql/mysql-slow.log
</span></span><span class="line"><span class="cl">  tag mysql.slow
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;parse&gt;</span>
</span></span><span class="line"><span class="cl">    @type none
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/parse&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;match</span> <span class="err">mysql.slow</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  @type http
</span></span><span class="line"><span class="cl">  buffer_type file
</span></span><span class="line"><span class="cl">  buffer_path /opt/uldra-agent/log/mysql.slow.*.buffer
</span></span><span class="line"><span class="cl">  flush_interval 1s
</span></span><span class="line"><span class="cl">  endpoint_url    http://192.168.56.101:5000/slowlog
</span></span><span class="line"><span class="cl">  serializer      json
</span></span><span class="line"><span class="cl">  bulk_request    true
</span></span><span class="line"><span class="cl">  http_method     post
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/match&gt;</span>
</span></span></code></pre></div><p>ì‚¬ì‹¤ ì´ í”ŒëŸ¬ê·¸ì¸ì´ í¸ë¦¬í•˜ê¸°ëŠ” í•˜ì§€ë§Œ.. ë¬¸ì œëŠ” í•œë²ˆì— ë‹¤ëŸ‰ì˜ ìŠ¬ë¡œìš° ì¿¼ë¦¬ê°€ ë°œìƒí–ˆì„ ì‹œ.. ì´ í”ŒëŸ¬ê·¸ì¸ì—ì„œ ë¬´í•œì • ë¦¬ì†ŒìŠ¤ë¥¼ ë¨¹ê¸° ë•Œë¬¸ì—.. ê°œì¸ì ìœ¼ë¡œëŠ” í™œìš©í•˜ê³  ìˆì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í™œìš©í•  ë°”ì—ëŠ” ì°¨ë¼ë¦¬, ì•ì„  ì—ëŸ¬ë¡œê·¸ ìˆ˜ì§‘ê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ <code>tail</code>ë¡œ ì†ŒìŠ¤ë¥¼ ë°›ì•„ì„œ ë³‘í•©ì„ API ì„œë²„ ë ˆë²¨ì—ì„œ í•´ì£¼ëŠ” ê²ƒì´ í›¨ì”¬ ì•ˆì •ì ì´ê³  ìœ ë¦¬í•  ë“¯ í•˜ë„¤ìš”. ^^</p>
<p>ê·¸ë¦¬ê³ , ì•„ì‰½ê²Œë„. ì´ í”„ë¡œì íŠ¸ëŠ” ë”ì´ìƒ ê°œë°œì´ ë˜ì§€ ì•ŠëŠ”ë“¯í•œ? (í˜¹ì€ ë‹¤ë¥¸ ì–´ë””ì„ ê°€ ìƒˆë¡­ê²Œ? ã…ã…)<br>
<a href="https://github.com/yuku/fluent-plugin-mysqlslowquery">https://github.com/yuku/fluent-plugin-mysqlslowquery</a></p>
<h3 id="33-fluent-plugin-mysql-query">3.3. fluent-plugin-mysql-query</h3>
<p>MySQLì— ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì„œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” í”ŒëŸ¬ê·¸ì¸ ì…ë‹ˆë‹¤. fluentdë¡œ ì£¼ê¸°ì ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¡œë¶€í„° ë°ì´í„°ë¥¼ ì¶”ì¶œí•´ì„œ ê²°ê³¼ë¥¼ íƒ€ê²Ÿìœ¼ë¡œ ë˜ì§ˆ ë•Œ ì¢‹ì„ë§Œí•œ í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;source&gt;</span>
</span></span><span class="line"><span class="cl">  @type           mysql_query
</span></span><span class="line"><span class="cl">  host            127.0.0.1
</span></span><span class="line"><span class="cl">  port            3306
</span></span><span class="line"><span class="cl">  username        fluentd
</span></span><span class="line"><span class="cl">  password        fluentd123
</span></span><span class="line"><span class="cl">  interval        30s
</span></span><span class="line"><span class="cl">  tag             mysql-query-01
</span></span><span class="line"><span class="cl">  query           select &#39;chan&#39; j, now() t;
</span></span><span class="line"><span class="cl">  record_hostname yes
</span></span><span class="line"><span class="cl">  nest_result     yes                 # Optional (default: no)
</span></span><span class="line"><span class="cl">  nest_key        data                # Optional (default: result)
</span></span><span class="line"><span class="cl">  row_count       yes                 # Optional (default: no)
</span></span><span class="line"><span class="cl">  row_count_key   row_count           # Optional (default: row_count)
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;match</span> <span class="err">mysql-query-01</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  @type http
</span></span><span class="line"><span class="cl">  buffer_type file
</span></span><span class="line"><span class="cl">  buffer_path /opt/db-agent/log/mysql.query01.*.buffer
</span></span><span class="line"><span class="cl">  flush_interval 1s
</span></span><span class="line"><span class="cl">  endpoint_url    http://192.168.56.101:5000/query
</span></span><span class="line"><span class="cl">  http_method     post
</span></span><span class="line"><span class="cl">  serializer      json
</span></span><span class="line"><span class="cl">  bulk_request    true
</span></span><span class="line"><span class="cl">  http_method     post
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/match&gt;</span>
</span></span></code></pre></div><p>ê°œì¸ì ìœ¼ë¡œëŠ” ì‚¬ìš©í•˜ê³  ìˆì§€ëŠ” ì•Šì§€ë§Œ.. í–¥í›„ í•„ìš”í•œ ê²½ìš° ìš”ê¸´í•˜ê²Œ í™œìš©í•˜ê¸° ìœ„í•´ ì €ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë„£ì–´ë†“ìŠµë‹ˆë‹¤.<br>
<a href="https://github.com/y-ken/fluent-plugin-mysql-query">https://github.com/y-ken/fluent-plugin-mysql-query</a></p>
<h1 id="startup-script">Startup script</h1>
<p><code>td-agent</code>ì˜ <code>init.d</code> ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì•½ê°„ì˜ ë³€ê²½(?)ì„ ì£¼ì–´ì„œ êµ¬ì„±í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ì¤‘ê°„ ë¶€ë¶„ì„ ë³´ê²Œë˜ë©´, jemallocìœ¼ë¡œ í”„ë¡œê·¸ë¨ì„ êµ¬ë™í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">### BEGIN INIT INFO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Provides:          my-agent</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Required-Start:    $network $local_fs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Required-Stop:     $network $local_fs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default-Start:     2 3 4 5</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default-Stop:      0 1 6</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Short-Description: data collector for Treasure Data</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Description:       my-agent is a data collector</span>
</span></span><span class="line"><span class="cl"><span class="c1">### END INIT INFO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pidfile:           /opt/my-agent/my-agent.pid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/sbin:/opt/my-agent/sbin:/bin:/usr/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_NAME</span><span class="o">=</span>my-agent
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_HOME</span><span class="o">=</span>/opt/my-agent
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_DEFAULT</span><span class="o">=</span>/etc/sysconfig/my-agent
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_USER</span><span class="o">=</span>root
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_GROUP</span><span class="o">=</span>root
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_RUBY</span><span class="o">=</span><span class="si">${</span><span class="nv">MY_AGENT_HOME</span><span class="si">}</span>/bin/ruby
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_BIN_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">MY_AGENT_HOME</span><span class="si">}</span>/sbin/my-agent
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_LOG_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">MY_AGENT_HOME</span><span class="si">}</span>/log/my-agent.log
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_PID_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">MY_AGENT_HOME</span><span class="si">}</span>/my-agent.pid
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_LOCK_FILE</span><span class="o">=</span>/var/lock/subsys/my-agent
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_OPTIONS</span><span class="o">=</span><span class="s2">&#34;--use-v1-config&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># timeout can be overridden from /etc/sysconfig/my-agent</span>
</span></span><span class="line"><span class="cl"><span class="nv">STOPTIMEOUT</span><span class="o">=</span><span class="m">120</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Read configuration variable file if it is present</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_DEFAULT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  . <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_DEFAULT</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Arguments to run the daemon with</span>
</span></span><span class="line"><span class="cl"><span class="nv">MY_AGENT_ARGS</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_ARGS</span><span class="k">:-</span><span class="si">${</span><span class="nv">MY_AGENT_BIN_FILE</span><span class="si">}</span><span class="p"> --log </span><span class="si">${</span><span class="nv">MY_AGENT_LOG_FILE</span><span class="si">}</span><span class="p"> </span><span class="si">${</span><span class="nv">MY_AGENT_OPTIONS</span><span class="si">}}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">START_STOP_DAEMON_ARGS</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">START_STOP_DAEMON_ARGS</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Exit if the package is not installed</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> -x <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_RUBY</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Source function library.</span>
</span></span><span class="line"><span class="cl">. /etc/init.d/functions
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define LSB log_* functions.</span>
</span></span><span class="line"><span class="cl"><span class="nv">lsb_functions</span><span class="o">=</span><span class="s2">&#34;/lib/lsb/init-functions&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> -f <span class="nv">$lsb_functions</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  . <span class="nv">$lsb_functions</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  log_success_msg<span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34; SUCCESS! </span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  log_failure_msg<span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34; ERROR! </span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  log_warning_msg<span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34; WARNING! </span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check the user</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_USER</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> ! getent passwd <span class="p">|</span> grep -q <span class="s2">&#34;^</span><span class="si">${</span><span class="nv">MY_AGENT_USER</span><span class="si">}</span><span class="s2">:&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$0</span><span class="s2">: user for running </span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2"> doesn&#39;t exist: </span><span class="si">${</span><span class="nv">MY_AGENT_USER</span><span class="si">}</span><span class="s2">&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  mkdir -p <span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  chown -R <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_USER</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">START_STOP_DAEMON_ARGS</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">START_STOP_DAEMON_ARGS</span><span class="si">}</span><span class="s2"> --user </span><span class="si">${</span><span class="nv">MY_AGENT_USER</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_GROUP</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> ! getent group -s files <span class="p">|</span> grep -q <span class="s2">&#34;^</span><span class="si">${</span><span class="nv">MY_AGENT_GROUP</span><span class="si">}</span><span class="s2">:&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$0</span><span class="s2">: group for running </span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2"> doesn&#39;t exist: </span><span class="si">${</span><span class="nv">MY_AGENT_GROUP</span><span class="si">}</span><span class="s2">&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nv">MY_AGENT_ARGS</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_ARGS</span><span class="si">}</span><span class="s2"> --group </span><span class="si">${</span><span class="nv">MY_AGENT_GROUP</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  mkdir -p <span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  chown -R <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_USER</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">MY_AGENT_ARGS</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_ARGS</span><span class="si">}</span><span class="s2"> --daemon </span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2012/04/17 Kazuki Ohta &lt;k@treasure-data.com&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Use jemalloc to avoid memory fragmentation</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_HOME</span><span class="si">}</span><span class="s2">/lib/libjemalloc.so&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">export</span> <span class="nv">LD_PRELOAD</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_HOME</span><span class="si">}</span><span class="s2">/lib/libjemalloc.so&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kill_by_file<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">local</span> <span class="nv">sig</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nb">shift</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="nb">local</span> <span class="nv">pid</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>cat <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span> 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">pid</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> /bin/kill <span class="s2">&#34;</span><span class="si">${</span><span class="nv">sig</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">pid</span><span class="si">}</span><span class="s2">&#34;</span> 1&gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Function that starts the daemon/service</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">do_start<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Set Max number of file descriptors for the safety sake</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># see http://docs.fluentd.org/en/articles/before-install</span>
</span></span><span class="line"><span class="cl">  <span class="nb">ulimit</span> -n <span class="m">65536</span> 1&gt;/dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  <span class="nb">local</span> <span class="nv">RETVAL</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">  daemon --pidfile<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span> <span class="si">${</span><span class="nv">START_STOP_DAEMON_ARGS</span><span class="si">}</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_RUBY</span><span class="si">}</span><span class="s2">&#34;</span> <span class="si">${</span><span class="nv">MY_AGENT_ARGS</span><span class="si">}</span> <span class="o">||</span> <span class="nv">RETVAL</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$?</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> touch <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_LOCK_FILE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nv">$RETVAL</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Function that stops the daemon/service</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">do_stop<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Return</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   0 if daemon has been stopped</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   1 if daemon was already stopped</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   2 if daemon could not be stopped</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   other if a failure occurred</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Use own process termination instead of killproc because killproc can&#39;t wait SIGTERM</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> kill_by_file -TERM <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      <span class="nb">local</span> i
</span></span><span class="line"><span class="cl">      <span class="k">for</span> i in <span class="k">$(</span>seq <span class="s2">&#34;</span><span class="si">${</span><span class="nv">STOPTIMEOUT</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> kill_by_file -0 <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">          sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="nb">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">      <span class="k">done</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> kill_by_file -0 <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -n <span class="s2">&#34;Timeout error occurred trying to stop </span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">        rm -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        rm -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_LOCK_FILE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> killproc <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PROG_NAME</span><span class="k">:-</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      rm -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">      rm -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_LOCK_FILE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Function that sends a SIGHUP to the daemon/service</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">do_reload<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  kill_by_file -HUP <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">do_restart<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> ! do_configtest<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nb">local</span> <span class="nv">val</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">  do_stop <span class="o">||</span> <span class="nv">val</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$?</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">val</span><span class="si">}</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">  <span class="m">0</span> <span class="p">|</span> <span class="m">1</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! do_start<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">  * <span class="o">)</span> <span class="c1"># Failed to stop</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">  <span class="k">esac</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">do_configtest<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">eval</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_ARGS</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">START_STOP_DAEMON_ARGS</span><span class="si">}</span><span class="s2"> --dry-run -q&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">RETVAL</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl"><span class="s2">&#34;start&#34;</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> -n <span class="s2">&#34;Starting </span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">: &#34;</span>
</span></span><span class="line"><span class="cl">  do_start <span class="o">||</span> <span class="nv">RETVAL</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$?</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$RETVAL</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">  <span class="m">0</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">    log_success_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">  * <span class="o">)</span>
</span></span><span class="line"><span class="cl">    log_failure_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">  <span class="k">esac</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;stop&#34;</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> -n <span class="s2">&#34;Stopping </span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">: &#34;</span>
</span></span><span class="line"><span class="cl">  do_stop <span class="o">||</span> <span class="nv">RETVAL</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$?</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$RETVAL</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">  <span class="m">0</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">    log_success_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">  * <span class="o">)</span>
</span></span><span class="line"><span class="cl">    log_failure_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">  <span class="k">esac</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;reload&#34;</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> -n <span class="s2">&#34;Reloading </span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">: &#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> ! do_configtest<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    log_failure_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> do_reload<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    log_success_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    log_failure_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;restart&#34;</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> -n <span class="s2">&#34;Restarting </span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">: &#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> do_restart<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    log_success_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    log_failure_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;status&#34;</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> kill_by_file -0 <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_PID_FILE</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    log_success_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2"> is running&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    log_failure_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2"> is not running&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;condrestart&#34;</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_LOCK_FILE</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -n <span class="s2">&#34;Restarting </span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">: &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> do_restart<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      log_success_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      log_failure_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;configtest&#34;</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> do_configtest<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    log_success_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    log_failure_msg <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MY_AGENT_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl">* <span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|reload|restart|condrestart|status|configtest}&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">  <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">  <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span></code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì•˜ìŠµë‹ˆë‹¤. (ë³„ê²ƒì•„ë‹ˆì¥¬?)</p>
<p>ì§€ê¸ˆê¹Œì§€ td-agentê³¼ ìœ ì‚¬í•˜ê²Œ, rubyì™€ ê¸°íƒ€ ë“±ë“±ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬/í”ŒëŸ¬ê·¸ì¸ë“¤ì„ íŒ¨í‚¤ì§•í•˜ëŠ” ë‚˜ë§Œì˜ fluentd ì—ì´ì „íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ëŠ” ê³¼ì •ì— ëŒ€í•´ì„œ ì´ì•¼ê¸°ë¥¼ í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ë¬¼ë¡ , ë²”ìš©ì ì¸ td-agentë¥¼ ì˜ í™œìš©í•´ë³´ëŠ” ë°©ë²•ë„ ìˆê² ì§€ë§Œ, íƒ€ ë¶€ì„œì™€ì˜ í˜¼ìš©ëœ í™˜ê²½ì„ ë°©ì§€í•˜ê³ ì, ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ë¡œ íŒ¨í‚¤ì§•ì„ í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ë‚¨ì€ ê²ƒì€ íŒ¨í‚¤ì§•í•œ ë‚˜ë§Œì˜ ì—ì´ì „íŠ¸ì— ë‚˜ë§Œì˜ ìš”êµ¬ì‚¬í•­ì„ ì˜ ì–¹ì–´ì„œ, ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§ì„ ìµœì ìœ¼ë¡œ ìœ ì§€ì‹œí‚¤ëŠ” ê²ƒì´ê² ì£ .</p>


        
          <div class="blog-tags">
            
              
              <a href="//localhost:1313/tags/fluentd/">fluentd</a>&nbsp;
            
              
              <a href="//localhost:1313/tags/my-agent/">my-agent</a>&nbsp;
            
              
              <a href="//localhost:1313/tags/mysql/">MySQL</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=%2f%2flocalhost%3a1313%2f2021%2f09%2fpackage-own-fluentd-agent%2f&amp;text=Fluentd%3f%20%eb%82%98%eb%a7%8c%ec%9d%98%20%ec%97%90%ec%9d%b4%ec%a0%84%ed%8a%b8%20%ed%8c%a8%ed%82%a4%ec%a7%95%21&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=%2f%2flocalhost%3a1313%2f2021%2f09%2fpackage-own-fluentd-agent%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=%2f%2flocalhost%3a1313%2f2021%2f09%2fpackage-own-fluentd-agent%2f&amp;title=Fluentd%3f%20%eb%82%98%eb%a7%8c%ec%9d%98%20%ec%97%90%ec%9d%b4%ec%a0%84%ed%8a%b8%20%ed%8c%a8%ed%82%a4%ec%a7%95%21" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=%2f%2flocalhost%3a1313%2f2021%2f09%2fpackage-own-fluentd-agent%2f&amp;title=Fluentd%3f%20%eb%82%98%eb%a7%8c%ec%9d%98%20%ec%97%90%ec%9d%b4%ec%a0%84%ed%8a%b8%20%ed%8c%a8%ed%82%a4%ec%a7%95%21" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=%2f%2flocalhost%3a1313%2f2021%2f09%2fpackage-own-fluentd-agent%2f&amp;title=Fluentd%3f%20%eb%82%98%eb%a7%8c%ec%9d%98%20%ec%97%90%ec%9d%b4%ec%a0%84%ed%8a%b8%20%ed%8c%a8%ed%82%a4%ec%a7%95%21" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=%2f%2flocalhost%3a1313%2f2021%2f09%2fpackage-own-fluentd-agent%2f&amp;description=Fluentd%3f%20%eb%82%98%eb%a7%8c%ec%9d%98%20%ec%97%90%ec%9d%b4%ec%a0%84%ed%8a%b8%20%ed%8c%a8%ed%82%a4%ec%a7%95%21" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/2022/05/mysql-heatwave/">MySQL Heatwaveë¥¼ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤</a></li>
                
                    <li><a href="/2021/07/mysql-document-store-test/">MySQL document store ì´ˆê°„ë‹¨ í…ŒìŠ¤íŠ¸</a></li>
                
                    <li><a href="/2021/07/make-own-query-exporter-with-go/">Goì–¸ì–´ë¡œ ë‚˜ë§Œì˜ Query Exporter ë§Œë“¤ì–´ë³´ê¸°!</a></li>
                
                    <li><a href="/2021/06/resetable-sequence-for-mysql/">MySQLì—ì„œ ë¦¬ì…‹ë˜ëŠ” ì‹œí€€ìŠ¤ ë§Œë“¤ì–´ë³´ê¸°</a></li>
                
                    <li><a href="/2020/08/mysql-binlog-memcached-plugin-collaboration/">MySQL binlogíŒŒì„œì™€  memcached pluginì˜ ì½œë¼ë³´ë ˆì´ì…˜!</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="//localhost:1313/2021/07/mysql-document-store-test/" data-toggle="tooltip" data-placement="top" title="MySQL document store ì´ˆê°„ë‹¨ í…ŒìŠ¤íŠ¸">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="//localhost:1313/2022/05/mysql-heatwave/" data-toggle="tooltip" data-placement="top" title="MySQL Heatwaveë¥¼ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
      
      
      
      
        
      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="mailto:gywndi@gmail.com" title="Email me">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://www.facebook.com/dongchan.sung" title="Facebook">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://github.com/gywndi" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://gywn.net">gywndi</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2011 - 2025
          

          
            &nbsp;&bull;&nbsp;
            <a href="//localhost:1313/">gywn&#39;s tech</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.147.8</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="//localhost:1313/js/main.js"></script>
<script src="//localhost:1313/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="//localhost:1313/js/load-photoswipe.js"></script>










    
  </body>
</html>

